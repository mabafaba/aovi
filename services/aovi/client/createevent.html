<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Event</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />

    <script src="/aovi/static/navigation.js"></script>
    <script src="/aovi/static/tabletags.js"></script>

    <link rel="stylesheet" href="/aovi/static/style.css" />

    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #app {
        position: relative;
        display: flex;
        flex-direction: column;
        overflow-y: scroll;
      }

      main-navigation {
        position: relative;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        height: 10%;
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        border-radius: 10px;
      }

      input {
        margin-bottom: 30px;
        padding: 5px;

        border-radius: 5px;
        border: 1px solid #ccc;
        background-color: #fff;
      }

      button {
        padding: 8px 16px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }

      #addRoomButton {
        background-color: #4caf50;
        color: white;
      }

      #addRoomButton:hover {
        background-color: #45a049;
      }

      #createEventButton {
        background-color: #008cba;
        color: white;
        margin-top: 20px;
        padding: 12px 24px;
        font-size: 16px;
      }

      #createEventButton:hover {
        background-color: #007b9a;
      }

      .remove-room-btn {
        background-color: #ff4444 !important;
        color: white !important;
        padding: 5px 10px !important;
        font-size: 12px !important;
      }

      .remove-room-btn:hover {
        background-color: #cc0000 !important;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      #app {
        margin-bottom: 150px;
        height: calc(100vh - 80px);
      }
    </style>
  </head>
  <body>
    <main-navigation
      menu-item-labels='["All Events","New Event", "Logout"]'
      menu-item-urls='["/aovi/views/events","/aovi/views/events/create","/aovi/user/logout"]'
    ></main-navigation>
    <div id="app">
      <h1>Create Event</h1>

      <!-- name input -->
      <label for="name">Name:</label>
      <input type="text" id="name" name="name" placeholder="Name" />

      <!-- title input -->
      <label for="title">Title:</label>
      <input type="text" id="title" name="title" placeholder="Title" />

      <!-- logo upload -->
      <label for="logo">Event Logo:</label>
      <input type="file" id="logo" name="logo" accept="image/*" />

      <!-- admin boundaries dropdown -->
      <label for="adminBoundariesDropdown">Geographic Area:</label>
      <select id="adminBoundariesDropdown"></select>

      <label for="tabletags">Participant Categories:</label>
      <div id="tabletagsContainer"></div>

      <div
        style="
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
          margin-top: 20px;
        "
      >
        <div
          style="
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
          "
        >
          <h3 style="margin: 0">Rooms:</h3>
          <button type="button" id="addRoomButton" onclick="addRoom()">
            + Add Room
          </button>
        </div>
        <div id="roomsContainer">
          <!-- Rooms will be added dynamically here -->
        </div>
      </div>

      <button id="createEventButton" onclick="postEvent()">Create Event</button>

      <div style="height: 200px">&nbsp;</div>
    </div>
    <!-- <svg width="960" height="600"></svg> -->
    <script>
      var container = document.getElementById("tabletagsContainer");
      var tableTags = new TableTags(container);

      // Function to add a new room
      function addRoom() {
        const roomsContainer = document.getElementById("roomsContainer");
        const roomCount = roomsContainer.children.length + 1;

        const roomDiv = document.createElement("div");
        roomDiv.className = "room-input";
        roomDiv.style.cssText =
          "display: flex; flex-direction: row; align-items: center; gap: 10px; margin-bottom: 10px;";

        roomDiv.innerHTML = `
            <label>Room ${roomCount}:</label>
            <input type="text" class="room-name" placeholder="Name" required>
            <input type="text" class="room-title" placeholder="Title" required>
            <button type="button" onclick="removeRoom(this)" class="remove-room-btn">Remove</button>
        `;

        roomsContainer.appendChild(roomDiv);
        updateRoomLabels();
      }

      // Function to remove a room
      function removeRoom(button) {
        button.parentElement.remove();
        updateRoomLabels();
      }

      // Function to update room labels after add/remove
      function updateRoomLabels() {
        const roomsContainer = document.getElementById("roomsContainer");
        const roomDivs = roomsContainer.children;

        for (let i = 0; i < roomDivs.length; i++) {
          const label = roomDivs[i].querySelector("label");
          label.textContent = `Room ${i + 1}:`;
        }
      }

      // Add the first room by default
      document.addEventListener("DOMContentLoaded", function () {
        addRoom();
      });

      // Function to convert file to base64
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = (error) => reject(error);
        });
      }

      const me = fetch("/aovi/user/me", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then((response) => response.json())
        .catch((error) => {
          console.error("Error fetching user data:", error);
        });

      const adminBoundaries = fetch("/aovi/geodata", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          const adminBoundariesDropdown = document.getElementById(
            "adminBoundariesDropdown"
          );
          for (const boundary of data) {
            const option = document.createElement("option");
            option.value = boundary.properties.shapeISO;
            option.textContent = `${boundary.properties.shapeISO} - ${boundary.properties.shapeName}`;
            adminBoundariesDropdown.appendChild(option);
          }
        });

      postEvent = async function () {
        var name = document.getElementById("name").value;
        var title = document.getElementById("title").value;
        var tabletags = tableTags.data;
        const adminBoundary = document.getElementById(
          "adminBoundariesDropdown"
        ).value;

        // Handle logo upload
        const logoFile = document.getElementById("logo").files[0];
        let logoBase64 = null;
        if (logoFile) {
          // Check file size (2MB = 2 * 1024 * 1024 bytes)
          const maxSizeInBytes = 2 * 1024 * 1024;
          if (logoFile.size > maxSizeInBytes) {
            alert(
              `Logo file is too large. Please choose a file smaller than 2MB. Current file size: ${(
                logoFile.size /
                1024 /
                1024
              ).toFixed(2)}MB`
            );
            return;
          }

          try {
            logoBase64 = await fileToBase64(logoFile);
          } catch (error) {
            console.error("Error converting logo to base64:", error);
            alert("Error uploading logo. Please try again.");
            return;
          }
        }

        // Validate that we have at least one room
        const roomsContainer = document.getElementById("roomsContainer");
        const roomDivs = roomsContainer.children;

        if (roomDivs.length === 0) {
          alert("Please add at least one room.");
          return;
        }

        // Collect room data
        const roomsData = [];
        for (let i = 0; i < roomDivs.length; i++) {
          const roomDiv = roomDivs[i];
          const roomName = roomDiv.querySelector(".room-name").value;
          const roomTitle = roomDiv.querySelector(".room-title").value;

          if (!roomName || !roomTitle) {
            alert(`Please fill in both name and title for Room ${i + 1}.`);
            return;
          }

          roomsData.push({
            name: roomName,
            title: roomTitle,
            data: { userCategories: tabletags, adminBoundary: adminBoundary },
          });
        }

        try {
          // Create the main room (first room in the list)
          const mainRoomData = {
            name: name || roomsData[0].name,
            title: title || roomsData[0].title,
            data: {
              userCategories: tabletags,
              adminBoundary: adminBoundary,
              ...(logoBase64 && { logo: logoBase64 }),
            },
          };

          const mainroom = await fetch("/aovi/rooms", {
            method: "POST",
            body: JSON.stringify(mainRoomData),
            headers: { "Content-Type": "application/json" },
          }).then((response) => response.json());

          // Create child rooms (skip the first one since it's the main room concept)
          const childRoomPromises = [];
          for (let i = 0; i < roomsData.length; i++) {
            const roomData = { ...roomsData[i] };
            roomData.parent = mainroom._id;

            const roomPromise = fetch("/aovi/rooms", {
              method: "POST",
              body: JSON.stringify(roomData),
              headers: { "Content-Type": "application/json" },
            });

            childRoomPromises.push(roomPromise);
          }

          // Wait for all child rooms to be created
          await Promise.all(childRoomPromises);

          // Go to main room registration
          location.assign(`/aovi/views/events/${mainroom._id}/registration`);
        } catch (error) {
          console.error("Error creating event:", error);
          alert("Error creating event. Please try again.");
        }
      };
    </script>
  </body>
</html>
